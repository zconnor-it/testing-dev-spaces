# Devfile for OpenShift Dev Spaces with Jupyter Notebook
# Reference: https://eclipse.dev/che/docs/stable/administration-guide/configuring-editors-definitions/

schemaVersion: 2.1.0

metadata:
  name: jupyter-workspace
  displayName: Jupyter Notebook Workspace
  description: Data science workspace with Jupyter Notebook (token authentication enabled)

components:
  # Explicit volume with size
  - name: projects
    volume:
      size: 5Gi

  - name: jupyter
    container:
      image: registry.access.redhat.com/ubi9/python-311:latest
      memoryLimit: 4Gi
      memoryRequest: 1Gi
      mountSources: true
      sourceMapping: /projects
      volumeMounts:
        - name: projects
          path: /projects
      # Install Jupyter and start with token authentication
      args:
        - /bin/bash
        - -c
        - |
          echo "Installing JupyterLab..."
          pip install jupyterlab
          
          # Generate a random token for this session
          JUPYTER_TOKEN=$(python -c "import secrets; print(secrets.token_hex(32))")
          
          echo ""
          echo "=============================================="
          echo "JUPYTER AUTHENTICATION TOKEN"
          echo "=============================================="
          echo "Your Jupyter token for this session:"
          echo ""
          echo "  $JUPYTER_TOKEN"
          echo ""
          echo "Use this token when prompted, or append to URL:"
          echo "  ?token=$JUPYTER_TOKEN"
          echo "=============================================="
          echo ""
          
          # Save token to file for easy retrieval
          echo "$JUPYTER_TOKEN" > /tmp/jupyter-token.txt
          
          echo "Starting JupyterLab on port 8888..."
          jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --ServerApp.token="$JUPYTER_TOKEN" --notebook-dir=/projects
      endpoints:
        - name: jupyter
          targetPort: 8888
          exposure: public
          protocol: https
          attributes:
            type: main
