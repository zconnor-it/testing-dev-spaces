# Editor definition that prevents VS Code from starting in OpenShift Dev Spaces
# This creates a "no-op" editor using Red Hat UBI that replaces the default VS Code editor
schemaVersion: 2.2.2
metadata:
  # Editor name - this will override/replace VS Code selections
  name: no-vscode
  displayName: No VS Code Editor (Red Hat UBI)
  description: Prevents VS Code from starting using Red Hat Universal Base Image
  tags:
    - Disabled
    - No-IDE
    - Red-Hat-UBI
  attributes:
    title: VS Code Disabled - Red Hat UBI
    # Supported architectures (Red Hat UBI supports both)
    arch:
      - x86_64
      - arm64
    # Publisher name
    publisher: redhat-custom
    # Version
    version: 1.0.0
    repository: https://github.com/eclipse/che
    firstPublicationDate: '2024-01-01'
    iconMediatype: image/svg+xml
    iconData: |
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="#EE0000" stroke-width="2" fill="none"/>
        <line x1="15" y1="9" x2="9" y2="15" stroke="#EE0000" stroke-width="2"/>
        <line x1="9" y1="9" x2="15" y2="15" stroke="#EE0000" stroke-width="2"/>
        <text x="12" y="18" text-anchor="middle" font-size="6" fill="#EE0000">UBI</text>
      </svg>

# Minimal components that don't actually start VS Code - using Red Hat UBI
components:
  - name: no-vscode-container
    attributes:
      app.kubernetes.io/component: no-vscode-runtime
      app.kubernetes.io/part-of: no-vscode-editor
    container:
      # Use Red Hat Universal Base Image (UBI) - minimal version for smaller footprint
      image: 'registry.access.redhat.com/ubi9/ubi-minimal:latest'
      # Command that just sleeps indefinitely without starting any IDE
      command:
        - /bin/bash
      args:
        - -c
        - |
          echo "========================================"
          echo "VS Code Startup Prevention - Red Hat UBI"
          echo "========================================"
          echo "VS Code has been disabled in this workspace"
          echo "Using Red Hat Universal Base Image (UBI9)"
          echo "This editor definition prevents VS Code from starting"
          echo "Container: $(cat /etc/redhat-release 2>/dev/null || echo 'Red Hat UBI')"
          echo "========================================"
          # Keep container alive but don't start any IDE
          exec sleep infinity
      # Minimal resource allocation
      memoryLimit: 64Mi
      memoryRequest: 32Mi
      cpuLimit: 100m
      cpuRequest: 50m
      env:
        - name: EDITOR_DISABLED
          value: "true"
        - name: NO_VSCODE_MESSAGE
          value: "VS Code startup has been prevented by Red Hat UBI container"
        - name: CONTAINER_TYPE
          value: "Red Hat UBI9 Minimal"
        - name: RED_HAT_CONTAINER
          value: "true"
      # Provide a dummy endpoint that doesn't serve VS Code
      endpoints:
        - name: no-vscode-endpoint
          attributes:
            type: main
            cookiesAuthEnabled: false
            discoverable: false
            urlRewriteSupported: false
          targetPort: 8080
          exposure: public
          secure: false
          protocol: http

# Events that run our no-op commands
events:
  preStart:
    - disable-vscode-command
  postStart:
    - show-disabled-message

# Commands that prevent VS Code startup using Red Hat UBI
commands:
  - id: disable-vscode-command
    exec:
      component: no-vscode-container
      commandLine: |
        echo "Preventing VS Code startup using Red Hat UBI..."
        echo "Container: Red Hat Universal Base Image (UBI9)"
        echo "VS Code has been disabled via custom Red Hat container-based editor definition"
        
  - id: show-disabled-message
    exec:
      component: no-vscode-container
      commandLine: |
        echo "=========================================="
        echo "VS Code Startup Prevention Active"
        echo "Red Hat UBI Container Implementation"
        echo "=========================================="
        echo "This workspace uses Red Hat Universal Base Image"
        echo "VS Code startup has been prevented by policy"
        echo "Container OS: $(cat /etc/redhat-release 2>/dev/null || echo 'Red Hat UBI9')"
        echo "Contact your administrator if you need IDE access"
        echo "=========================================="
