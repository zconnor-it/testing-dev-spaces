# Editor definition that prevents VS Code from starting in OpenShift Dev Spaces
# This creates a minimal "no-IDE" editor using Red Hat UBI that replaces the default VS Code editor
# Based on: https://eclipse.dev/che/docs/stable/administration-guide/configuring-editors-definitions/
schemaVersion: 2.2.2
metadata:
  # Editor name - must consist of lower case alphanumeric characters, '-' or '.'
  name: no-vscode
  displayName: No VS Code Editor (Red Hat UBI)
  description: Minimal workspace without VS Code - uses Red Hat Universal Base Image
  tags:
    - No-IDE
    - Minimal
    - Red-Hat-UBI
  attributes:
    title: Minimal Workspace - No VS Code
    # Supported architectures
    arch:
      - x86_64
      - arm64
    # Publisher name (MANDATORY)
    publisher: redhat-custom
    # Version (MANDATORY)
    version: 1.0.0
    repository: https://github.com/zconnor-it/testing-dev-spaces
    firstPublicationDate: '2024-01-01'
    iconMediatype: image/svg+xml
    iconData: |
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="#EE0000" stroke-width="2" fill="none"/>
        <line x1="15" y1="9" x2="9" y2="15" stroke="#EE0000" stroke-width="2"/>
        <line x1="9" y1="9" x2="15" y2="15" stroke="#EE0000" stroke-width="2"/>
      </svg>

# Components for the no-IDE workspace
components:
  # Init container that prepares the workspace (runs during preStart)
  - name: no-vscode-injector
    container:
      # Red Hat UBI minimal for init container
      image: 'registry.access.redhat.com/ubi9/ubi-minimal:latest'
      command:
        - /bin/sh
      args:
        - -c
        - |
          echo "No VS Code Editor - Init Complete"
          echo "Red Hat UBI container ready"
      memoryLimit: 64Mi
      memoryRequest: 32Mi
      cpuLimit: 100m
      cpuRequest: 50m
      volumeMounts:
        - name: workspace-data
          path: /workspace-data

  # Runtime container with container-contribution for merging with user's devfile
  - name: no-vscode-runtime
    attributes:
      app.kubernetes.io/component: no-vscode-runtime
      app.kubernetes.io/part-of: no-vscode-editor
      # This allows the container to be merged with the user's workspace container
      controller.devfile.io/container-contribution: true
    container:
      # Red Hat UBI - this image is used as a base but gets merged with user's container
      image: 'registry.access.redhat.com/ubi9/ubi-minimal:latest'
      memoryLimit: 128Mi
      memoryRequest: 64Mi
      cpuLimit: 200m
      cpuRequest: 100m
      env:
        - name: EDITOR_DISABLED
          value: "true"
        - name: NO_VSCODE
          value: "true"
        - name: CONTAINER_TYPE
          value: "Red Hat UBI9 Minimal"
      volumeMounts:
        - name: workspace-data
          path: /workspace-data
      # Minimal endpoint - not serving any IDE
      endpoints:
        - name: no-vscode-status
          attributes:
            type: main
            cookiesAuthEnabled: false
            discoverable: false
            urlRewriteSupported: false
          targetPort: 8080
          exposure: public
          secure: false
          protocol: http

  # Ephemeral volume for workspace data
  - name: workspace-data
    volume:
      ephemeral: true

# Events that control startup sequence
events:
  # preStart uses apply commands for init containers
  preStart:
    - init-no-vscode
  # postStart uses exec commands that run after workspace is ready
  postStart:
    - show-status-message

# Commands for the workspace lifecycle
commands:
  # Apply command for init container (runs during preStart)
  - id: init-no-vscode
    apply:
      component: no-vscode-injector

  # Exec command for post-start messaging
  - id: show-status-message
    exec:
      component: no-vscode-runtime
      commandLine: |
        echo "=========================================="
        echo "No VS Code Workspace Active"
        echo "=========================================="
        echo "VS Code has been disabled in this workspace"
        echo "Container: Red Hat Universal Base Image (UBI9)"
        echo "Your workspace components are running"
        echo "=========================================="
